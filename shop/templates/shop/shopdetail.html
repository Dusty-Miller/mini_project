{% extends 'shop/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ post.title }} - Dusty Shop{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- ÏôºÏ™Ω: Ïù¥ÎØ∏ÏßÄ -->
    <div class="col-md-6 d-flex align-items-start flex-column justify-content-center">
      {% if post.uploaded_image %}
        {% for img in post.images.all %}
          <img class="img-fluid mb-3" src="{{ img.image.url }}" alt="{{ post.title }}" style="min-height: 1000px; width: auto; object-fit: contain;">
        {% endfor %}
      {% endif %}
    </div>

    <!-- Ïò§Î•∏Ï™Ω: ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ -->
    <div class="col-md-6">
      <div style="position: sticky; top: 400px;">
        <h3 class="fw-bold" style="color: #555555">{{ post.title }}</h3>

        <h4 class="fw-bold pt-4 pb-1" style="font-size:16px; color: #555555">DETAIL</h4>
        <ul style="font-size:16px;">{{ post.content }}</ul>

        <h4 class="fw-bold pt-2 pb-2" style="font-size:16px; color: #555555">SIZE {{ post.size }}</h4>
        <div style="display: flex; align-items: center;">
          <a style="font-size:16px;">{{ post.summary }}</a>
        </div>

        <h4 class="fw-bold pt-3 pb-2" style="font-size:16px; color: #555555">CARE</h4>
        <ul style="font-size:16px; margin-bottom: 40px;">
          <li>COLOR BLEEDING WARNING</li>
          <li>WASH DARK COLOR SEPERATELY</li>
          <li>MACHINE WASH COLD</li>
          <li>ÏºÄÏñ¥ÎùºÎ≤® Ï∞∏Í≥†</li>
          <li>Î∞òÌíàÎ∂àÍ∞Ä</li>
        </ul>

        {% if post.category and post.category.slug != "event" %}
          <!-- ÏùºÎ∞ò ÏÉÅÌíàÏùº Í≤ΩÏö∞ -->
          <hr class="divider">
          <h3 style="font-size:16px;">‚Ç© {{ post.price|intcomma }}</h3>
          <p class="mt-3">{{ post.body }}</p>

          <div class="button-group" style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 20px;">
            {% if user.is_authenticated %}
              {% if is_wished %}
                <form action="{% url 'remove_from_wishlist' post.pk %}" method="post">
                  {% csrf_token %}
                  <button class="btn btn-dark" type="submit" style="min-width: 120px;">‚ù§Ô∏è</button>
                </form>
              {% else %}
                <form action="{% url 'add_to_wishlist' post.pk %}" method="post">
                  {% csrf_token %}
                  <button class="btn btn-dark" type="submit" style="min-width: 120px;">‚ô°</button>
                </form>
              {% endif %}
            {% endif %}

            <form id="cartForm" action="{% url 'add_to_cartlist' post.pk %}" method="post" onsubmit="handleCartSidebar(event)">
              {% csrf_token %}
              <button id="addToCartBtn" class="btn btn-dark" type="submit" style="min-width: 120px;">Add to Cart</button>
            </form>
            <a class="btn btn-dark" href="#" style="min-width: 120px;">Buy</a>
          </div>
        {% else %}
          <!-- Ïù¥Î≤§Ìä∏Ïùº Í≤ΩÏö∞: Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ -->
          <div id="chat-box" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; margin-bottom:10px;"></div>
          <div style="display:flex; gap:10px;">
            <input type="text" id="chat-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" class="form-control" />
            <button id="send-btn" class="btn btn-dark">Ï†ÑÏÜ°</button>
          </div>

          <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
          <script>
            const eventId = {{ post.id }};
            let lastMessageId = 0;

            // CSRF ÌÜ†ÌÅ∞ ÏÑ§Ï†ï
            $.ajaxSetup({
              headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              }
            });

            function addMessage(msg) {
              $('#chat-box').append(`<p><b>${msg.user__username}:</b> ${msg.message}</p>`);
              $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
            }

            function fetchMessages() {
              $.get("{% url 'get_messages' %}", {
                event_id: eventId,
                last_id: lastMessageId
              }, function(data) {
                data.forEach(msg => {
                  addMessage(msg);
                  lastMessageId = msg.id;
                });
              });
            }

            $('#send-btn').click(function() {
              const message = $('#chat-input').val();
              if (message.trim() === '') return;

              $.post("{% url 'send_message' %}", {
                message: message,
                event_id: eventId
              }, function(res) {
                if (res.status === 'ok') {
                  $('#chat-input').val('');
                     fetchMessages(); // Ï†ÑÏÜ° ÌõÑ Î∞îÎ°ú Í∞±Ïã†
                } else {
                  alert('Ï†ÑÏÜ° Ïã§Ìå®');
                }
              });
            });

            setInterval(fetchMessages, 2000);
            $(document).ready(fetchMessages);
          </script>
        {% endif %}

        <!-- Ïû•Î∞îÍµ¨Îãà ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <div id="cartSidebar" style="
          position: fixed;
          top: 0;
          right: -300px;
          width: 300px;
          height: 100%;
          background-color: white;
          box-shadow: -2px 0 5px rgba(0,0,0,0.2);
          transition: right 0.3s ease;
          padding: 20px;
          z-index: 1000;
        ">
          <h3>üõí Ïû•Î∞îÍµ¨ÎãàÏóê Ï∂îÍ∞ÄÎê®!</h3>
          <div id="cartItemInfo"></div>
        </div>

        <script>
          function handleCartSidebar(e) {
            e.preventDefault();

            const item = {
              name: '{{ post.title }}',
              price: '{{ post.price|intcomma }}',
              size: '{{ post.size }}',
              image: '{{ post.uploaded_image.url }}'
            };

            sessionStorage.setItem('cartItem', JSON.stringify(item));

            const cartInfo = document.getElementById('cartItemInfo');
            cartInfo.innerHTML = `
              <div style="border:1px solid #ccc; border-radius:10px; padding:10px; margin-bottom:15px;">
                <img src="${item.image}" alt="${item.name}" style="width:100%; border-radius:10px;">
                <h5 style="margin-top:10px;">${item.name}</h5>
                <p>Í∞ÄÍ≤©: ${item.price}</p>
                <p>ÏÇ¨Ïù¥Ï¶à: ${item.size}</p>
              </div>
            `;

            const sidebar = document.getElementById('cartSidebar');
            sidebar.style.right = '0';

            setTimeout(() => {
              sidebar.style.right = '-300px';
              document.getElementById('cartForm').submit();
            }, 2000);
          }
        </script>
      </div>
    </div>
  </div>
</div>
{% endblock %}

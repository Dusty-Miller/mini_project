{% extends 'shop/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ post.title }} - Dusty Shop{% endblock %}

{% block content %}

{% if messages %}
<script>
  {% for message in messages %}
    alert("{{ message|escapejs }}");
  {% endfor %}
</script>
{% endif %}

<div class="container my-5">
  <div class="row">
    <!-- 왼쪽: 썸네일 이미지 -->
    <div class="col-md-2">
      <div style="position: sticky; top: 100px;">
        <div class="d-flex flex-column align-items-start" style="gap: 10px;">
          {% for img in post.images.all %}
            <img src="{{ img.image.url }}"
                 class="img-thumbnail {% if post.category.slug == 'event' %}dusty-image{% endif %}"
                 style="width: 70%; cursor: pointer;"
                 onclick="document.getElementById('mainImage').src='{{ img.image.url }}'"
                 alt="thumbnail">
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 가운데: 메인 이미지 + 코멘트 -->
    <div class="col-md-7">
      {% if post.images.all %}
        <img id="mainImage"
             class="img-fluid mb-3 {% if post.category.slug == 'event' %}dusty-image{% endif %}"
             src="{{ post.images.first.image.url }}"
             alt="{{ post.title }}"
             style="max-height: 800px; width: 100%; object-fit: contain;">
      {% endif %}
        {% if post.category and post.category.slug == "event" %}
          <div style="margin-top: 20px;">
            <h2 style="font-weight: bold; color: #333; text-align: center">💬 Make offer 💬</h2>
            <div class="mb-3">
              <h5 style="color: #444; text-align: center">📌 시작 가격: ₩ {{ post.starting_price|intcomma }}</h5>
            </div>

            <div id="chat-box" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; margin-bottom:10px;"></div>

            <!-- 가격 제시 입력창 + 버튼 그룹 -->
            <div class="d-flex gap-2" style="margin-bottom: 10px;">
              <input type="number" id="chat-input" class="form-control" placeholder="가격을 제시하세요." style="height: 48px;" />
              <button id="send-btn" class="btn btn-dark" style="height: 48px; white-space: nowrap;">🏆입찰</button>
              {% if request.user.is_superuser %}
                <form action="{% url 'finalize_bid' post.pk %}" method="post" style="margin:0;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger" style="height: 48px; white-space: nowrap;">🏆 낙찰</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endif %}

    </div>

    <!-- 오른쪽: 상세 설명 + 버튼 -->
    <div class="col-md-3">
      <div style="position: sticky; top: 100px;">
        <h3 class="fw-bold" style="color: #555555">{{ post.title }}</h3>

        <h4 class="fw-bold pt-4 pb-1" style="font-size:16px; color: #555555">DETAIL</h4>
        <p style="font-size:16px;">{{ post.content }}</p>

        <h4 class="fw-bold pt-2 pb-2" style="font-size:16px; color: #555555">SIZE</h4>
        <p style="font-size:16px;">{{ post.size }}</p>

        <h4 class="fw-bold pt-3 pb-2" style="font-size:16px; color: #555555">CARE</h4>
        <ul style="font-size:16px;">
          <li>COLOR BLEEDING WARNING</li>
          <li>WASH DARK COLOR SEPERATELY</li>
          <li>MACHINE WASH COLD</li>
          <li>케어라벨 참고</li>
          <li>반품불가</li>
        </ul>

        {% if post.category and post.category.slug != "event" %}
          <hr class="divider">
          <h3 style="font-size:16px;">₩ {{ post.price|intcomma }}</h3>
          <p class="mt-3">{{ post.body }}</p>

          <div class="button-group d-flex flex-column gap-2 mt-3">
            {% if user.is_authenticated %}
              {% if is_wished %}
                <form action="{% url 'remove_from_wishlist' post.pk %}" method="post">
                  {% csrf_token %}
                  <button class="btn btn-dark w-100" type="submit">❤️ 찜 해제</button>
                </form>
              {% else %}
                <form action="{% url 'add_to_wishlist' post.pk %}" method="post">
                  {% csrf_token %}
                  <button class="btn btn-dark w-100" type="submit">♡ 찜하기</button>
                </form>
              {% endif %}
            {% endif %}

            <form action="{% url 'add_to_cartlist' post.pk %}" method="post" onsubmit="handleCartSidebar(event)">
              {% csrf_token %}
              <button id="addToCartBtn" class="btn btn-dark w-100" type="submit">Add to Cart</button>
            </form>

            <form action="{% url 'checkout' post.pk %}" method="get">
              <button id="buy" class="btn btn-dark w-100" type="submit">지금 바로 구매</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 장바구니 사이드바 -->
  <div id="cartSidebar" style="
    position: fixed;
    top: 0;
    right: -300px;
    width: 300px;
    height: 100%;
    background-color: white;
    box-shadow: -2px 0 5px rgba(0,0,0,0.2);
    transition: right 0.3s ease;
    padding: 20px;
    z-index: 1000;
  ">
    <h3>🛒 장바구니에 추가됨!</h3>
    <div id="cartItemInfo"></div>
  </div>
</div>

{% if post.category and post.category.slug == "event" %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const eventId = {{ post.id }};
  let lastMessageId = 0;
  let highestBid = {{ post.starting_price|default:0 }};

  $.ajaxSetup({
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  });

function addMessage(msg) {
  const bidValue = parseInt(msg.message.replace(/[^0-9]/g, ''));
  const isValidBid = !isNaN(bidValue) && bidValue > 0;

  let formattedMessage = msg.message;

  if (isValidBid) {
    if (/^\d+$/.test(msg.message.trim())) {
      formattedMessage = `₩ ${bidValue.toLocaleString()}`;
    }

    if (bidValue > highestBid) {
      highestBid = bidValue;
      $('#highest-bid').text(`💰 최고 입찰가: ₩ ${highestBid.toLocaleString()}`);
    }
  }

  // 시간 포맷 변환 (예: 2024-08-12 14:32)
  const timestamp = new Date(msg.timestamp);
  const formattedTime = timestamp.toLocaleString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit'
  });

  const messageElement = $(`
    <p>
      <b>${msg.user__username}</b> <span style="color:gray; font-size:0.9em;">(${formattedTime})</span>: ${formattedMessage}
    </p>
  `);

  $('#chat-box').append(messageElement);
  $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);

  setTimeout(() => {
    messageElement.remove();
  }, 60000);
}


  function fetchMessages() {
    $.get("{% url 'get_messages' %}", {
      event_id: eventId,
      last_id: lastMessageId
    }, function(data) {
      data.forEach(msg => {
        addMessage(msg);
        lastMessageId = msg.id;
      });
    });
  }

function sendBid() {
  const message = $('#chat-input').val();
  const bid = parseInt(message);

  if (message.trim() === '' || isNaN(bid) || bid <= 0) {
    alert('숫자만 입력해주세요.');
    return;
  }

  if (bid <= highestBid) {
    alert(`현재 최고 입찰가보다 높은 금액을 입력해주세요. (현재: ₩ ${highestBid.toLocaleString()})`);
    return;
  }

  $.post("{% url 'send_message' %}", {
    message: message,
    event_id: eventId
  }, function(res) {
    if (res.status === 'ok') {
      $('#chat-input').val('');
      fetchMessages();
    } else {
      alert('로그인 하세요');
    }
  });
}



  $('#send-btn').click(function() {
    sendBid();
  });

  $('#chat-input').keydown(function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendBid();
    }
  });

  $(document).ready(function() {
    fetchMessages();
    $('#chat-box').before(`<div id="highest-bid" style="font-weight:bold; color:#d35400; text-align:center; margin-bottom:10px;">💰 최고 입찰가: ₩ {{ post.starting_price|intcomma }}</div>`);
  });

  setInterval(fetchMessages, 2000);
</script>
{% endif %}

{% endblock %}

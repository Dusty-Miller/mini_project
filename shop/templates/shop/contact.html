{% extends 'shop/base.html' %}
{% block content %}

<!-- 문의하기 폼 -->
<div style="max-width: 1000px; margin: 60px auto; padding: 32px;
            background:#fff; border-radius:16px;
            box-shadow:0 8px 24px rgba(0,0,0,.08);">

  <h2 style="text-align:center; margin-bottom:24px; font-size:28px; font-weight:700;">문의하기</h2>

  {# ✅ SPA: id 부여, JS가 submit 가로채서 /api/comments/ 로 전송 #}
  <form id="commentForm" enctype="multipart/form-data" style="margin-bottom: 40px;">
    {% csrf_token %}

    <!-- 제목 -->
    {% if commentform.title %}
      <div style="margin-bottom:16px;">
        <label for="{{ commentform.title.id_for_label }}" style="display:block;margin-bottom:8px;font-weight:600;">
          {{ commentform.title.label }}
        </label>
        {{ commentform.title }}
      </div>
    {% endif %}

    <!-- 내용 -->
    <div style="margin-bottom:24px;">
      <label for="{{ commentform.content.id_for_label }}" style="display:block;margin-bottom:8px;font-weight:600;">
        {{ commentform.content.label }}
      </label>
      {{ commentform.content }}
    </div>

    <!-- 사진(한 장) -->
    <div id="upload-row" style="display:flex; align-items:center; gap:16px; padding-bottom: 20px;">
        {{ commentform.uploaded_image }}
        <label for="{{ commentform.uploaded_image.id_for_label }}"
               id="preview"
               style="width:120px;height:120px;border:1px solid #ccc;border-radius:6px;
                      background:#f9f9f9;display:flex;align-items:center;justify-content:center;
                      color:#bbb;font-size:24px; cursor:pointer;">
          +
        </label>
    </div>

    <!-- 제출 버튼 -->
    <button type="submit"
            style="display:block; width:100%; padding:12px; font-size:16px; font-weight:600;
                   background:#212529; color:#fff; border:none; border-radius:8px; cursor:pointer;"
            onmouseover="this.style.opacity='0.9'"
            onmouseout="this.style.opacity='1'">
      제출
    </button>
  </form>

  <!-- 문의 목록 -->
  <hr style="border:1px solid #000; margin-bottom:400px;">
  <h2 style="text-align:center; margin-bottom:100px; font-size:28px; font-weight:700;">문의내역</h2>
  <hr style="border:1px solid #000; margin-bottom:20px;">

{% if comments %}
  <ul id="commentsList" style="list-style:none; padding:0; margin:0;">  {# ✅ 갱신 타겟 id #}
    {% for comment in comments %}
      <li class="comment-item" style="border-bottom:1px solid #ddd; padding:12px 0; margin-top:0;">

        {% if comment.title %}
          <div style="margin-top:6px; margin-bottom:6px; font-size:24px; font-weight:700;">
            제목 : {{ comment.title }}
          </div>
        {% endif %}

        {% if comment.author == user or request.user.is_staff %}
            <p style="margin:6px 0 0; line-height:1.6; white-space:pre-wrap;">{{ comment.content }}</p>
        {% else %}
            <p style="margin:6px 0 0; line-height:1.6; white-space:pre-wrap;">비공개</p>
        {% endif %}
        
        {% if comment.uploaded_image %}
          {% if comment.author == user or request.user.is_staff %}
            <div style="margin-top:20px;">
              <img src="{{ comment.uploaded_image.url }}"
                   alt=""
                   class="comment-img"
                   style="width:160px;height:160px;object-fit:cover;border-radius:6px;
                          border:1px solid #eee; cursor:pointer;">
            </div>
          {% else %}
            <div style="margin-top:20px;">
              <img src="https://dummyimage.com/100x100/ced4da/6c757d.jpg"
                   alt=""
                   class="comment-img"
                   style="width:160px;height:160px;object-fit:cover;border-radius:6px;
                          border:1px solid #eee; cursor:pointer;">
            </div>
          {% endif %}
        {% endif %}

        <div style="display:flex; align-items:center; margin-top:-4px;">
          <span style="font-size:16px; font-weight:700; margin-left:auto;">
            {% if comment.author == user or request.user.is_staff %}
              Username - {{ comment.author }}
            {% else %}
              Username - ******
            {% endif %}
          </span>
          <span style="color: gray; font-size:0.9em; margin-left:8px;">
            {{ comment.created_date|date:"Y-m-d H:i" }}
          </span>
        </div>

        {% if comment.replies.all %}
          <details style="margin-top:4px;">
            <summary style="cursor:pointer; font-size:14px; padding:6px 10px;
              background:#f8f9fa; border:1px solid #ccc; border-radius:6px;
              display:inline-block; user-select:none; background-color:#212529;
              color:white; font-family:'Segoe UI', Arial, sans-serif;">
              관리자 답변 ({{ comment.replies.count }})
            </summary>

            <ul style="list-style:none; padding:0; margin:12px 0 12px 0;">
              {% for reply in comment.replies.all %}
              <li style="margin-bottom: 13px; padding:8px 12px; border-left:3px solid #e9ecef; background:#fafafa; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; color:#6c757d; font-size:14px;">
                  <span>
                    <strong>
                      {{ reply.author }}
                      {% if reply.author.is_staff %}
                        <span style="font-size:12px; color:#0d6efd; border:1px solid #0d6efd; border-radius:4px; padding:1px 6px; margin-left:6px;">
                          관리자
                        </span>
                      {% endif %}
                    </strong>
                  </span>
                  <span>{{ reply.created_date|date:"Y-m-d H:i" }}</span>
                </div>
              
                <div style="margin-top:4px; margin-bottom:4px; line-height:1.4; white-space:pre-line;">
                  {{ reply.content }}
                </div>
              </li>
              {% endfor %}
            </ul>
          </details>
        {% endif %}

      </li>
    {% endfor %}
  </ul>
{% else %}
  <ul id="commentsList" style="list-style:none; padding:0; margin:0;"></ul>
  <p style="margin-top:8px;">아직 등록된 문의가 없습니다.</p>
{% endif %}

<!-- 단일 이미지 미리보기 -->
<script>
(function(){
  const row = document.getElementById('upload-row');
  if (!row) return;
  const input = row.querySelector('input[type="file"]');
  const box = document.getElementById('preview');
  if (!input || !box) return;

  box.addEventListener('click', () => input.click());

  input.addEventListener('change', function () {
    const f = this.files && this.files[0];
    if (!f) {
      box.style.background = '#f9f9f9';
      box.style.backgroundImage = '';
      box.textContent = '+';
      return;
    }
    const r = new FileReader();
    r.onload = e => {
      box.style.backgroundImage = `url(${e.target.result})`;
      box.style.backgroundSize = 'cover';
      box.style.backgroundPosition = 'center';
      box.textContent = '';
    };
    r.readAsDataURL(f);
  });
})();
</script>

<!-- 확대용 모달 -->
<div id="imgModal" style="display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;
                           background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
  <span id="imgClose" style="position:absolute;top:20px;right:35px;color:#fff;font-size:40px;cursor:pointer;">&times;</span>
  <img id="imgModalContent" style="max-width:90%;max-height:90%;border-radius:8px;">
</div>

<script>
const modal = document.getElementById("imgModal");
const modalImg = document.getElementById("imgModalContent");
const modalClose = document.getElementById("imgClose");

document.querySelectorAll(".comment-img").forEach(img => {
  img.addEventListener("click", () => {
    modal.style.display = "flex";
    modalImg.src = img.src;
  });
});

modalClose.addEventListener("click", () => {
  modal.style.display = "none";
});

modal.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.style.display = "none";
  }
});
</script>

{# ✅ SPA 핵심 JS: 폼 새로고침 막고 /api/comments/ 로 전송 + 목록 갱신 #}
<script>
// CSRF
function getCookie(name){
  const parts = document.cookie.split(';').map(c=>c.trim());
  for(const c of parts){ if(c.startsWith(name+'=')) return decodeURIComponent(c.split('=')[1]); }
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('commentForm');
  const list = document.getElementById('commentsList');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();                     // 🔥 전체 새로고침 차단

    // FormData로 변환(파일 업로드 지원)
    const fd = new FormData(form);

    // root 문의라면 post/parent가 비어 있어도 됨 (API가 허용)
    try{
      const res = await fetch('/api/comments/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
          // ⚠️ FormData 사용 시 'Content-Type' 지정하지 말 것 (브라우저가 boundary 포함해 자동 설정)
        },
        body: fd
      });

      if(!res.ok){
        const err = await res.json().catch(()=>({}));
        alert('등록 실패: ' + JSON.stringify(err));
        return;
      }

      const item = await res.json();

      // 입력 초기화
      // (Django의 form 위젯 id는 보통 id_<fieldname> 형식)
      const contentEl = document.getElementById('{{ commentform.content.id_for_label }}');
      if (contentEl) contentEl.value = '';
      const fileEl = document.getElementById('{{ commentform.uploaded_image.id_for_label }}');
      if (fileEl) fileEl.value = '';
      const preview = document.getElementById('preview');
      if (preview){
        preview.style.backgroundImage = ''; preview.textContent = '+';
      }

      // 목록에 즉시 반영(최상단 prepend)
      const li = document.createElement('li');
      li.className = 'comment-item';
      li.style.cssText = 'border-bottom:1px solid #ddd; padding:12px 0; margin-top:0;';
      li.innerHTML = `
        ${item.title ? `<div style="margin-top:6px; margin-bottom:6px; font-size:24px; font-weight:700;">
          Title - ${item.title}
        </div>` : ''}

        <div style="font-size:20px; font-weight:600;">Content</div>
        <p style="margin:6px 0 0; line-height:1.6; white-space:pre-wrap;">${item.content ?? ''}</p>

        ${item.image_url ? `
          <div style="margin-top:20px;">
            <img src="${item.image_url}" class="comment-img"
                 style="width:160px;height:160px;object-fit:cover;border-radius:6px;border:1px solid #eee; cursor:pointer;">
          </div>` : ''}

        <div style="display:flex; align-items:center; margin-top:-4px;">
          <span style="font-size:16px; font-weight:700; margin-left:auto;">
            Username - ${item.author_name || '익명'}
          </span>
          <span style="color: gray; font-size:0.9em; margin-left:8px;">
            ${new Date(item.created_date).toLocaleString()}
          </span>
        </div>
      `;
      list?.prepend(li);
    }catch(e){
      console.error(e);
      alert('등록 중 오류가 발생했습니다.');
    }
  });
});
</script>

{% endblock %}

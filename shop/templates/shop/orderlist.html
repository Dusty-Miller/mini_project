{% extends 'shop/base.html' %}
{% block title %}{% endblock %}
{% load humanize %}
{% block content %}
<section class="px-5">
  <div class="container px-4 px-lg-5 mt-5">
    <h2 class="mb-4 text-center">Order history</h2>

    <div class="card">
      <div class="card-body">

        {# --- 이벤트(낙찰/프로모션) 섹션 --- #}
        <h5 class="mb-3">이벤트(낙찰/프로모션)</h5>
        {% for order in event_orders %}
          <div class="row align-items-center mb-3 pb-3 border-bottom">
            <div class="col-md-3">
              {% if order.post.uploaded_image %}
                <img src="{{ order.post.uploaded_image.url }}" alt="{{ order.post.title }}" class="img-fluid rounded" style="max-height: 100px; object-fit: cover;">
              {% else %}
                <img src="https://dummyimage.com/100x100/ced4da/6c757d.jpg" alt="No image" class="img-fluid rounded">
              {% endif %}
            </div>
            <div class="col-md-9">
              <div>
                <strong>{{ order.post.title }}</strong>
                {% if user.is_superuser and order.user %}
                  <span style="color:#666; font-size:.9rem;">(주문자: {{ order.user.username }})</span>
                {% endif %}
              </div>

              <div>₩{{ order.amount|intcomma }}</div>
              <div style="font-size:0.9rem; color:#888;">
                주문일: {{ order.created_at|date:"Y-m-d H:i" }}
              </div>

              {% if user.is_superuser %}
                <div class="mt-1 d-flex justify-content-end gap-2">
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'shopdetail' order.post.pk %}">배송준비중</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'order_status' %}">배송출발</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'remove_from_orderlist' order.post.pk %}">배송완료</a>
                </div>
              {% else %}
                <div class="mt-1 d-flex justify-content-end gap-2">
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'shopdetail' order.post.pk %}">상세 보기</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'order_status' %}">배송 조회</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'remove_from_orderlist' order.post.pk %}">내역 삭제</a>
                </div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-3">이벤트 주문 내역이 없습니다.</div>
        {% endfor %}

        {# --- 일반 결제 섹션 --- #}
        <h5 class="mt-4 mb-3">일반 결제</h5>
        {% for order in regular_orders %}
          <div class="row align-items-center mb-3 pb-3 border-bottom">
            <div class="col-md-3">
              {% if order.post.uploaded_image %}
                <img src="{{ order.post.uploaded_image.url }}" alt="{{ order.post.title }}" class="img-fluid rounded" style="max-height: 100px; object-fit: cover;">
              {% else %}
                <img src="https://dummyimage.com/100x100/ced4da/6c757d.jpg" alt="No image" class="img-fluid rounded">
              {% endif %}
            </div>
            <div class="col-md-9">
              <div>
                <strong>{{ order.post.title }}</strong>
                {% if user.is_superuser and order.user %}
                  <span style="color:#666; font-size:.9rem;">(주문자: {{ order.user.username }})</span>
                {% endif %}
              </div>

              <div>₩{{ order.amount|intcomma }}</div>
              <div style="font-size:0.9rem; color:#888;">
                주문일: {{ order.created_at|date:"Y-m-d H:i" }}
              </div>

              {% if user.is_superuser %}
                <div class="mt-1 d-flex justify-content-end gap-2">
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'shopdetail' order.post.pk %}">배송준비중</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'order_status' %}">배송출발</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'remove_from_orderlist' order.post.pk %}">배송완료</a>
                </div>
              {% else %}
                <div class="mt-1 d-flex justify-content-end gap-2">
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'shopdetail' order.post.pk %}">상세 보기</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'order_status' %}">배송 조회</a>
                  <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'remove_from_orderlist' order.post.pk %}">내역 삭제</a>
                </div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-3">일반 결제 내역이 없습니다.</div>
        {% endfor %}

      </div>
    </div>
  </div>
</section>
{% endblock %}
